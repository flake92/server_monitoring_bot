## 1. Установка и настройка

### 1.1 Требования
- Python 3.9+
- PostgreSQL 14+
- Telegram Bot Token от @BotFather

### 1.2 Установка PostgreSQL
1. Установка на Ubuntu:
```bash
sudo apt update
sudo apt install postgresql postgresql-contrib
sudo systemctl start postgresql
sudo systemctl enable postgresql
```

2. Создание базы данных и пользователя:
```bash
sudo -u postgres psql
CREATE DATABASE server_monitoring;
CREATE USER monitor_user WITH PASSWORD 'secure_password';
ALTER ROLE monitor_user SET client_encoding TO 'utf8';
ALTER ROLE monitor_user SET default_transaction_isolation TO 'read committed';
ALTER ROLE monitor_user SET timezone TO 'UTC';
GRANT ALL PRIVILEGES ON DATABASE server_monitoring TO monitor_user;
\q
```

### 1.3 Установка зависимостей
Создайте файл `requirements.txt`:
```
aiogram==2.25.1
psycopg2-binary==2.9.9
python-dotenv==1.0.0
aiohttp==3.9.1
ping3==4.0.3
```

Установите зависимости:
```bash
pip install -r requirements.txt
```
Настройте `.env` в корне проекта:
```
BOT_TOKEN=your_bot_token_here
DB_HOST=localhost
DB_PORT=5432
DB_NAME=server_monitoring
DB_USER=monitor_user
DB_PASSWORD=secure_password
ADMIN_IDS=123456789,987654321
```

## 8. Инструкции по запуску

1. Создайте все файлы и директории как указано в структуре проекта.
2. Установите PostgreSQL и создайте базу данных.
3. Установите зависимости из `requirements.txt`.
4. Создайте файл `.env` с необходимыми параметрами.
5. Инициализируйте базу данных:
```bash
psql -U monitor_user -d server_monitoring -f database/schema.sql
```
6. Запустите бота:
```bash
python main.py
```

## 9. Функционал

### Пользователи
- Регистрация через `/start` с отправкой заявки на модерацию.
- После одобрения:
  - Доступ к меню управления серверами (добавить, просмотреть, проверить статус).
  - Добавление серверов с указанием названия, адреса и типа проверки (ICMP, HTTP, HTTPS).
  - Просмотр списка своих серверов с возможностью редактирования или удаления.
  - Проверка статуса своих серверов через кнопку "Проверить статус".
- Уведомления о недоступности и восстановлении серверов с периодом охлаждения 20 секунд.

### Администраторы
- Доступ к админ-панели через `/admin`.
- Просмотр и модерация заявок пользователей (одобрение/отклонение).
- Просмотр всех одобренных пользователей и их серверов.
- Очистка очереди уведомлений.

### Мониторинг
- Периодическая проверка всех серверов (каждую минуту).
- Поддержка типов проверки: ICMP, HTTP, HTTPS.
- Логирование статуса серверов в базе данных.
- Уведомления о начале и окончании недоступности с учетом периода охлаждения (20 секунд).
- Сообщения содержат: название сервера, адрес, время начала и окончания недоступности.

### База данных
- Хранение пользователей, их серверов, статусов серверов и уведомлений.
- Каждый пользователь имеет собственный список серверов (связь через `user_id`).
- Индексы для оптимизации запросов.

## 10. Примечания
- Схема базы данных обновлена: таблица `servers` теперь включает поле `user_id` для связи серверов с пользователями.
- Пользователи могут управлять только своими серверами, что обеспечивается проверками `user_id` в запросах.
- Администраторы могут просматривать сервера всех пользователей через админ-панель.
- Период охлаждения предотвращает ложные уведомления о краткосрочной недоступности (<20 секунд).
- Все действия логируются в файл `bot.log` для отладки и мониторинга.