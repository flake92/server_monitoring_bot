Telegram Server Monitoring Bot
Описание проекта
Telegram Server Monitoring Bot — это модульный Telegram бот, разработанный для мониторинга доступности серверов с использованием протоколов ICMP, HTTP и HTTPS. Бот позволяет пользователям добавлять, редактировать, удалять и просматривать свои собственные списки серверов после прохождения модерации администратором. Каждый пользователь имеет независимый список серверов, изолированный от других пользователей. Бот включает систему уведомлений с периодом охлаждения (20 секунд) для предотвращения ложных или краткосрочных сообщений о недоступности серверов. Для хранения данных используется PostgreSQL, а проект реализован на Python с использованием библиотеки aiogram.
Основные возможности
Для пользователей:

Регистрация: Пользователи отправляют заявку на использование бота через команду /start.
Модерация: Все новые пользователи должны быть одобрены администратором.
Управление серверами (после одобрения):
Добавление серверов с указанием названия, адреса и типа проверки (ICMP, HTTP, HTTPS).
Просмотр списка своих серверов с возможностью редактирования или удаления.
Проверка статуса серверов через интерактивное меню.


Уведомления: Получение сообщений о недоступности и восстановлении серверов с указанием:
Названия сервера
Адреса
Времени начала недоступности
Времени восстановления (если применимо)


Период охлаждения: Уведомления отправляются только если недоступность длится более 20 секунд.

Для администраторов:

Админ-панель: Доступ через команду /admin для пользователей, указанных в конфигурации как администраторы.
Модерация пользователей: Одобрение или отклонение заявок новых пользователей.
Управление пользователями: Просмотр списка всех одобренных пользователей и их серверов.
Очистка очереди: Возможность сброса очереди неподтвержденных уведомлений.

Мониторинг:

Периодическая проверка серверов (каждую минуту).
Поддержка типов проверки: ICMP (ping), HTTP, HTTPS.
Логирование всех проверок в базе данных.
Уведомления о сбоях с учетом периода охлаждения.

База данных:

Используется PostgreSQL для хранения:
Пользователей (ID, имя, статус, и т.д.)
Серверов (принадлежащих конкретным пользователям)
Статусов серверов (доступность, время проверки)
Уведомлений (сообщения, статус отправки)


Индексы для оптимизации производительности запросов.

Требования

Операционная система: Linux (инструкции для Ubuntu 20.04/22.04)
Python: 3.9 или выше
PostgreSQL: 14 или выше
Telegram Bot Token: Полученный через @BotFather в Telegram
Интернет-соединение: Для взаимодействия с Telegram API и проверки серверов

Структура проекта
server_monitoring_bot/
├── config/
│   └── config.py           # Конфигурация бота (токен, параметры БД)
├── database/
│   ├── __init__.py
│   ├── models.py          # Модели данных (User, Server, ServerStatus, Notification)
│   ├── db_manager.py      # Управление взаимодействием с PostgreSQL
│   └── schema.sql         # Схема базы данных
├── handlers/
│   ├── __init__.py
│   ├── user_handlers.py   # Обработчики пользовательских команд и действий
│   ├── admin_handlers.py  # Обработчики админских команд
│   └── monitoring_handlers.py  # Обработчики мониторинга серверов
├── services/
│   ├── __init__.py
│   ├── monitoring.py      # Логика проверки серверов
│   ├── notification.py    # Управление уведомлениями
│   └── cooldown.py        # Управление периодом охлаждения
├── utils/
│   ├── __init__.py
│   └── logger.py          # Настройка логирования
├── requirements.txt        # Зависимости проекта
├── main.py                 # Главный файл запуска бота
└── README.md               # Документация (этот файл)

Установка и настройка на Linux сервере (Ubuntu)
Следующие шаги описывают процесс установки и запуска бота на сервере под управлением Ubuntu 20.04 или 22.04.
Шаг 1: Обновление системы
Обновите пакеты системы для обеспечения актуальности:
sudo apt update && sudo apt upgrade -y

Шаг 2: Установка Python
Убедитесь, что Python 3.9 или выше установлен:
python3 --version

Если Python отсутствует или версия ниже 3.9, установите его:
sudo apt install python3.9 python3-pip python3-venv -y

Шаг 3: Установка PostgreSQL

Установите PostgreSQL 14:

sudo apt install postgresql postgresql-contrib -y


Проверьте, что служба PostgreSQL запущена:

sudo systemctl status postgresql

Если служба не активна, запустите и включите автозапуск:
sudo systemctl start postgresql
sudo systemctl enable postgresql


Создайте пользователя и базу данных для бота:

sudo -u postgres psql

В оболочке psql выполните:
CREATE DATABASE server_monitoring;
CREATE USER monitor_user WITH PASSWORD 'secure_password';
ALTER ROLE monitor_user SET client_encoding TO 'utf8';
ALTER ROLE monitor_user SET default_transaction_isolation TO 'read committed';
ALTER ROLE monitor_user SET timezone TO 'UTC';
GRANT ALL PRIVILEGES ON DATABASE server_monitoring TO monitor_user;
\q

Замените secure_password на надежный пароль.
Шаг 4: Клонирование проекта

Установите Git, если он не установлен:

sudo apt install git -y


Склонируйте репозиторий проекта (или скопируйте файлы вручную):

git clone <repository_url> server_monitoring_bot
cd server_monitoring_bot

Если репозитория нет, создайте структуру директорий и файлов, как указано выше, используя предоставленный код.
Шаг 5: Настройка виртуального окружения

Создайте и активируйте виртуальное окружение:

python3 -m venv venv
source venv/bin/activate


Установите зависимости из requirements.txt:

pip install -r requirements.txt

Содержимое requirements.txt:
aiogram==2.25.1
psycopg2-binary==2.9.9
python-dotenv==1.0.0
aiohttp==3.9.1
ping3==4.0.3

Шаг 6: Настройка конфигурации

Создайте файл .env в корне проекта:

nano .env

Добавьте следующие параметры:
BOT_TOKEN=your_bot_token_here
DB_HOST=localhost
DB_PORT=5432
DB_NAME=server_monitoring
DB_USER=monitor_user
DB_PASSWORD=secure_password
ADMIN_IDS=123456789,987654321


BOT_TOKEN: Получите токен у @BotFather в Telegram.
DB_PASSWORD: Используйте тот же пароль, что указали при создании пользователя PostgreSQL.
ADMIN_IDS: Список ID администраторов через запятую (ваш Telegram ID можно узнать у @userinfobot).

Сохраните файл и закройте редактор (Ctrl+O, Enter, Ctrl+X в nano).

Убедитесь, что файл .env имеет ограниченные права доступа:

chmod 600 .env

Шаг 7: Инициализация базы данных

Примените схему базы данных:

psql -U monitor_user -d server_monitoring -f database/schema.sql

Введите пароль monitor_user, когда будет запрошен.
Схема базы данных (database/schema.sql) создает таблицы:

users: Для хранения информации о пользователях и их статусе.
servers: Для хранения серверов, привязанных к пользователям.
server_status: Для логирования статуса серверов.
notifications: Для хранения уведомлений.

Шаг 8: Проверка файлов проекта
Убедитесь, что все файлы проекта созданы в соответствии с предоставленной структурой и содержат код, описанный в проекте. Основные файлы:

config/config.py: Конфигурация.
database/models.py, db_manager.py, schema.sql: Управление БД.
handlers/user_handlers.py, admin_handlers.py, monitoring_handlers.py: Обработчики команд.
services/monitoring.py, notification.py, cooldown.py: Логика мониторинга и уведомлений.
utils/logger.py: Логирование.
main.py: Точка входа.

Шаг 9: Запуск бота

Убедитесь, что вы находитесь в виртуальном окружении:

source venv/bin/activate


Запустите бота:

python main.py

Бот начнет работу, логи будут записываться в файл bot.log и выводиться в консоль.
Шаг 10: Настройка фонового выполнения
Для постоянной работы бота используйте systemd или screen.
Вариант 1: Использование systemd

Создайте файл службы:

sudo nano /etc/systemd/system/telegram-bot.service

Добавьте:
[Unit]
Description=Telegram Server Monitoring Bot
After=network.target

[Service]
User=<your_username>
WorkingDirectory=/path/to/server_monitoring_bot
ExecStart=/path/to/server_monitoring_bot/venv/bin/python main.py
Restart=always

[Install]
WantedBy=multi-user.target

Замените:

<your_username>: Ваш пользователь Linux.
/path/to/server_monitoring_bot: Путь к директории проекта.


Активируйте и запустите службу:

sudo systemctl daemon-reload
sudo systemctl start telegram-bot
sudo systemctl enable telegram-bot


Проверьте статус:

sudo systemctl status telegram-bot

Вариант 2: Использование screen

Запустите screen:

screen -S bot


Активируйте виртуальное окружение и запустите бота:

source venv/bin/activate
python main.py


Отсоединитесь от сессии: Ctrl+A, затем D.
Для возврата к сессии:

screen -r bot

Использование
Для пользователей

Найдите бота в Telegram по его имени (заданному при создании через @BotFather).
Отправьте команду /start для регистрации. Ваша заявка будет отправлена на модерацию.
После одобрения администратором вы получите доступ к меню:
Добавить сервер: Введите название, адрес и выберите тип проверки.
Мои сервера: Просмотр списка серверов с возможностью редактирования или удаления.
Проверить статус: Проверка текущей доступности ваших серверов.


Вы будете получать уведомления о недоступности и восстановлении серверов.

Для администраторов

Отправьте команду /admin (доступно только для ID, указанных в ADMIN_IDS).
В админ-панели доступны функции:
Просмотр и модерация заявок пользователей.
Просмотр всех одобренных пользователей и их серверов.
Очистка очереди уведомлений.



Логирование

Все действия бота логируются в файл bot.log в корне проекта.
Логи включают временные метки, уровень (INFO, ERROR и т.д.) и описание событий.
Для просмотра логов:

tail -f bot.log

Отладка и устранение неисправностей
Ошибка подключения к PostgreSQL

Проверьте, что PostgreSQL запущен: sudo systemctl status postgresql.
Убедитесь, что параметры в .env совпадают с настройками базы данных.
Проверьте права доступа пользователя monitor_user.

Ошибка Telegram API

Убедитесь, что BOT_TOKEN в .env правильный.
Проверьте интернет-соединение сервера.

Бот не запускается

Проверьте, что все зависимости установлены: pip install -r requirements.txt.
Убедитесь, что вы активировали виртуальное окружение: source venv/bin/activate.
Просмотрите bot.log для выявления ошибок.

Добавление серверов вручную (для тестирования)
Администраторы или разработчики могут добавлять сервера напрямую в базу данных:
psql -U monitor_user -d server_monitoring
INSERT INTO servers (user_id, name, address, check_type)
VALUES (123456789, 'Test Server', 'example.com', 'https');

Замените 123456789 на ID пользователя, который должен владеть сервером.
Расширения и доработки

Добавление новых типов проверок: Расширьте services/monitoring.py для поддержки других протоколов.
Расширенные уведомления: Добавьте форматирование или дополнительные данные в уведомления.
Админские команды: Реализуйте дополнительные функции, такие как удаление пользователей или серверов.
Веб-интерфейс: Создайте веб-панель для управления ботом.

Лицензия
Этот проект распространяется под лицензией MIT (или другой, если требуется). Убедитесь, что вы соблюдаете лицензии используемых библиотек (aiogram, psycopg2, и т.д.).
Контакты
Для вопросов или предложений свяжитесь с разработчиком через Telegram или создайте issue в репозитории проекта.
